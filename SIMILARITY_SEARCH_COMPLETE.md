# Document Similarity Search - Complete Implementation

This document describes the complete implementation of vector-based similarity search for documents, including automatic embedding generation and UI integration.

## Overview

The similarity search feature uses vector embeddings generated by Ollama's embedding model to find semantically similar documents. Embeddings are automatically generated when documents are created or updated, and can also be generated in bulk during index rebuilds.

## Architecture

### Components

1. **DocumentEmbedding Entity** (`com.docmgmt.model.DocumentEmbedding`)
   - Stores vector embeddings in the database
   - Contains: document reference, embedding JSON, content hash (SHA-256), timestamps
   - One-to-one relationship with Document

2. **DocumentEmbeddingRepository** (`com.docmgmt.repository.DocumentEmbeddingRepository`)
   - JPA repository for accessing embeddings
   - Provides `findByDocument()` method

3. **DocumentSimilarityService** (`com.docmgmt.service.DocumentSimilarityService`)
   - Core service for similarity operations
   - Methods:
     - `generateEmbedding(Document)` - Generate and store embedding for a document
     - `findSimilar(Long documentId, int limit)` - Find similar documents by ID
     - `findSimilarByText(String queryText, int limit)` - Semantic search by text
     - `findSimilarByTextWithFilters(...)` - Hybrid search with filters
     - `rebuildAllEmbeddings()` - Regenerate all embeddings

4. **SearchController REST API** (`com.docmgmt.controller.SearchController`)
   - Endpoints:
     - `GET /api/search/similar/{documentId}?limit=10` - Find similar documents
     - `POST /api/search/similar?q=text&limit=10` - Semantic text search
     - `POST /api/search/embeddings/{documentId}` - Generate embedding for document
     - `POST /api/search/embeddings/rebuild` - Rebuild all embeddings

5. **LuceneIndexService Integration** (`com.docmgmt.search.LuceneIndexService`)
   - Updated to automatically generate embeddings during index rebuild
   - Controlled by `docmgmt.similarity.auto-generate-embeddings` property

6. **FolderView UI** (`com.docmgmt.ui.views.FolderView`)
   - "Find Similar Documents" button in document detail dialog
   - Dialog showing similar documents with similarity scores
   - Double-click to open similar document

## Configuration

Configuration is managed in `application.properties`:

```properties
# Document Similarity / Embedding Configuration
docmgmt.similarity.auto-generate-embeddings=true
docmgmt.similarity.async-generation=true

# Ollama Embedding Model
spring.ai.ollama.embedding.options.model=llama3.2
```

### Configuration Options

- **`docmgmt.similarity.auto-generate-embeddings`** (default: `false`)
  - When `true`: Embeddings are automatically generated when documents are created/updated
  - When `true` in LuceneIndexService: Embeddings are generated during index rebuild
  
- **`docmgmt.similarity.async-generation`** (default: `true`)
  - When `true`: Embedding generation happens asynchronously (non-blocking)
  - When `false`: Embedding generation is synchronous (blocks document save)

- **`spring.ai.ollama.embedding.options.model`** (default: `llama3.2`)
  - Specifies which Ollama model to use for embeddings
  - Other options: `mxbai-embed-large`, `nomic-embed-text`, etc.

## Automatic Embedding Generation

### On Document Save

When `docmgmt.similarity.auto-generate-embeddings=true`, embeddings are generated automatically:

1. User saves/updates a document via UI or API
2. `DocumentService.save()` is called
3. After saving, `generateEmbeddingForDocument()` is triggered (async by default)
4. Service checks if embedding exists and is up-to-date (via content hash)
5. If needed, generates new embedding using document content:
   - Document name, description, keywords, tags
   - Text content from all text/* content objects (up to 8000 chars)
6. Embedding stored in `document_embeddings` table

### On Index Rebuild

When running index rebuild with auto-generation enabled:

1. Admin triggers index rebuild via API or UI
2. `LuceneIndexService.rebuildIndex(documents)` is called
3. After rebuilding Lucene index, checks `autoGenerateEmbeddings` flag
4. If enabled, calls `similarityService.rebuildAllEmbeddings()`
5. Processes all documents in database
6. Generates embeddings for all (skips if unchanged via hash check)

### Manual Generation

Embeddings can be manually generated via REST API:

```bash
# Generate embedding for specific document
curl -X POST http://localhost:8082/docmgmt/api/search/embeddings/123

# Rebuild all embeddings
curl -X POST http://localhost:8082/docmgmt/api/search/embeddings/rebuild
```

## Using Similarity Search

### Via UI

1. Open any document in the Folder View
2. Click "Find Similar Documents" button (below version control buttons)
3. Dialog opens showing loading indicator
4. Results appear with:
   - Document name
   - Description
   - Similarity score (as percentage)
5. Double-click any result to open that document

### Via REST API

**Find Similar Documents:**
```bash
curl http://localhost:8082/docmgmt/api/search/similar/123?limit=10
```

Response:
```json
[
  {
    "document": {
      "id": 456,
      "name": "Related Document",
      "description": "...",
      ...
    },
    "similarity": 0.87
  },
  ...
]
```

**Semantic Text Search:**
```bash
curl -X POST "http://localhost:8082/docmgmt/api/search/similar?q=machine%20learning&limit=5"
```

**Hybrid Search with Filters:**
```bash
curl -X POST http://localhost:8082/docmgmt/api/search/similar-filtered \
  -H "Content-Type: application/json" \
  -d '{
    "queryText": "neural networks",
    "filters": {
      "type": "TECHNICAL_REPORT"
    },
    "limit": 10
  }'
```

## How It Works

### Embedding Generation

1. **Content Extraction**: Combines document metadata and text content
2. **Vector Generation**: Calls Ollama embedding API with extracted text
3. **Storage**: Serializes float[] vector to JSON and stores in database
4. **Hash Calculation**: SHA-256 hash of content for change detection

### Similarity Calculation

1. **Retrieval**: Loads target document's embedding from database
2. **Comparison**: Calculates cosine similarity with all other embeddings
3. **Ranking**: Sorts by similarity score (descending)
4. **Filtering**: Returns top N results (excludes query document itself)

### Cosine Similarity Formula

```
similarity = (A · B) / (||A|| × ||B||)
```

Where:
- A, B are embedding vectors
- A · B is the dot product
- ||A||, ||B|| are vector magnitudes

Result range: -1 to 1 (typically 0 to 1 for semantic similarity)

## Database Schema

### document_embeddings table

```sql
CREATE TABLE document_embeddings (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  document_id BIGINT NOT NULL,
  embedding TEXT NOT NULL,           -- JSON array of doubles
  content_hash VARCHAR(64),          -- SHA-256 hash
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (document_id) REFERENCES documents(id),
  UNIQUE INDEX (document_id)
);
```

## Performance Considerations

### Current Implementation

- **In-Memory Similarity**: All embeddings loaded into memory for comparison
- **O(n) Complexity**: Linear scan through all documents
- **Suitable for**: < 1000 documents
- **Typical Query Time**: 100-500ms for 100 documents

### For Larger Scale (Future)

Consider these optimizations:

1. **Vector Database**: Use pgvector (PostgreSQL), Milvus, or Qdrant
2. **Approximate Search**: Use HNSW or IVF indexing
3. **Caching**: Cache frequently accessed embeddings
4. **Batch Processing**: Generate embeddings in batches
5. **Dimensionality Reduction**: Use PCA to reduce vector size

## Troubleshooting

### No Similar Documents Found

**Possible causes:**
1. Document has no embedding yet
2. Ollama service is not running
3. Auto-generation is disabled

**Solutions:**
- Check `docmgmt.similarity.auto-generate-embeddings=true`
- Verify Ollama is running: `curl http://localhost:11434/api/tags`
- Manually generate: `POST /api/search/embeddings/{documentId}`
- Rebuild all: `POST /api/search/embeddings/rebuild`

### Slow Similarity Search

**Possible causes:**
1. Large number of documents (> 1000)
2. Ollama model is slow
3. Network latency to Ollama

**Solutions:**
- Use faster embedding model (e.g., `mxbai-embed-large`)
- Ensure Ollama runs locally (not remote)
- Consider vector database for large scale

### Embeddings Not Auto-Generated

**Check:**
1. Property set: `docmgmt.similarity.auto-generate-embeddings=true`
2. Logs for errors: `grep -i embedding logs/application.log`
3. Ollama accessibility: `curl http://localhost:11434/api/embeddings -d '{"model":"llama3.2","prompt":"test"}'`

### Content Hash Mismatch

If embeddings aren't updating when content changes:
1. Check if content is being indexed properly
2. Verify text content has `contentType` starting with `text/`
3. Force regeneration via API

## Best Practices

### Embedding Generation

1. **Enable Auto-Generation**: Set `auto-generate-embeddings=true` for convenience
2. **Use Async Mode**: Keep `async-generation=true` for better performance
3. **Batch Operations**: Use rebuild API for bulk generation
4. **Monitor Failures**: Check logs for embedding generation errors

### Content Organization

1. **Rich Metadata**: Provide good descriptions and keywords
2. **Text Content**: Ensure documents have indexable text content
3. **Consistency**: Use consistent terminology across documents

### Search Usage

1. **Appropriate Limits**: Use limit=10-20 for UI, adjust for API
2. **Combine with Filters**: Use hybrid search for better precision
3. **Threshold Scores**: Consider showing only results > 0.5 similarity

### Performance

1. **Index Rebuilds**: Schedule during off-hours
2. **Monitor Size**: Track embedding count and database size
3. **Scale Planning**: Consider vector DB when approaching 1000 documents

## Future Enhancements

Potential improvements:

1. **Vector Database Integration**: PostgreSQL with pgvector extension
2. **Approximate Nearest Neighbors**: HNSW or IVF indexing
3. **Multi-Modal Embeddings**: Include images, not just text
4. **Custom Models**: Train domain-specific embedding models
5. **Relevance Feedback**: Learn from user interactions
6. **Clustering**: Group similar documents automatically
7. **Visualization**: 2D/3D projection of document space (t-SNE/UMAP)

## Example Use Cases

### 1. Find Related Technical Documents

User views "Database Migration Guide" and clicks "Find Similar":
- Shows: "Database Backup Procedures", "Schema Design Patterns", etc.
- Similarity scores: 0.78, 0.65, 0.61...

### 2. Semantic Content Search

User searches "how to deploy applications":
- Finds documents about deployment, CI/CD, containers
- Without exact keyword matches

### 3. Duplicate Detection

Before uploading new document:
- Generate embedding from content
- Search for similarity > 0.95
- Warn user about potential duplicates

### 4. Content Recommendation

When viewing document:
- Show "You might also be interested in..." sidebar
- Display top 3 similar documents

## Integration with Other Features

### Plugin System
- Translation plugins can use similarity to find already-translated versions
- Summary plugins can find summarized versions

### Version Control
- Compare similarity across versions
- Track content drift over time

### Search
- Combine keyword search (Lucene) with semantic search (embeddings)
- Hybrid ranking: 0.5 × keyword_score + 0.5 × similarity_score

## References

- Spring AI Documentation: https://docs.spring.io/spring-ai/reference/
- Ollama Embeddings API: https://github.com/ollama/ollama/blob/main/docs/api.md#generate-embeddings
- Cosine Similarity: https://en.wikipedia.org/wiki/Cosine_similarity
- HNSW Algorithm: https://arxiv.org/abs/1603.09320
