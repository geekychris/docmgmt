# Similarity Search Documentation

## Overview

The document management system now includes **vector-based similarity search** using embeddings generated by Spring AI with Ollama. This allows semantic search based on document content meaning, not just keyword matching.

## Features

- **Content-Based Embeddings**: Generates vector embeddings from document metadata (name, description, keywords, tags) and actual content
- **Cosine Similarity**: Uses cosine similarity to find semantically related documents
- **Hybrid Search**: Combines similarity search with field filters
- **Incremental Updates**: Only regenerates embeddings when content changes (using SHA-256 hashing)
- **REST API**: Full programmatic access to all similarity functions

## Architecture

### Components

1. **DocumentEmbedding** entity - Stores vector embeddings in database
2. **DocumentSimilarityService** - Core service for generating and searching embeddings
3. **SearchController** - REST API endpoints for similarity search
4. **EmbeddingModel** - Spring AI integration with Ollama for vector generation

### How It Works

1. Document content is extracted (metadata + text content)
2. Content is hashed to detect changes
3. Embedding vector is generated using Ollama (via Spring AI)
4. Vector is serialized as JSON and stored in database
5. Similarity search uses cosine similarity between vectors

## REST API

### Generate Embedding for a Document

```bash
POST /api/search/embeddings/{documentId}
```

**Example:**
```bash
curl -X POST http://localhost:8082/api/search/embeddings/1
```

### Find Similar Documents by Document ID

```bash
GET /api/search/similar/{documentId}?limit=10
```

**Example:**
```bash
curl "http://localhost:8082/api/search/similar/5?limit=10"
```

**Response:**
```json
[
  {
    "documentId": 12,
    "name": "Related Document",
    "similarity": 0.8542
  },
  {
    "documentId": 8,
    "name": "Another Similar Doc",
    "similarity": 0.7891
  }
]
```

### Find Similar Documents by Text Query

```bash
POST /api/search/similar?q=query+text&limit=10
```

**Example:**
```bash
curl -X POST "http://localhost:8082/api/search/similar?q=machine+learning+tutorial&limit=5"
```

### Find Similar with Field Filters

```bash
POST /api/search/similar?q=query+text&limit=10
Content-Type: application/json

{
  "name": "tutorial",
  "type": "REFERENCE"
}
```

**Example:**
```bash
curl -X POST "http://localhost:8082/api/search/similar?q=spring+boot&limit=10" \
  -H "Content-Type: application/json" \
  -d '{"name": "tutorial", "description": "guide"}'
```

### Rebuild All Embeddings

```bash
POST /api/search/embeddings/rebuild
```

**Example:**
```bash
curl -X POST http://localhost:8082/api/search/embeddings/rebuild
```

## Use Cases

### 1. Find Related Documents

Find documents semantically related to a specific document:

```bash
curl "http://localhost:8082/api/search/similar/123?limit=5"
```

### 2. Semantic Search

Search by meaning rather than exact keywords:

```bash
curl -X POST "http://localhost:8082/api/search/similar?q=how+to+configure+database+connection"
```

This will find documents about database configuration even if they don't use those exact words.

### 3. Hybrid Search

Combine semantic similarity with traditional filters:

```bash
curl -X POST "http://localhost:8082/api/search/similar?q=java+tutorial&limit=10" \
  -H "Content-Type: application/json" \
  -d '{"type": "TUTORIAL"}'
```

### 4. Duplicate Detection

Find potential duplicates with high similarity scores:

```bash
curl "http://localhost:8082/api/search/similar/45?limit=20" | jq '.[] | select(.similarity > 0.9)'
```

## Database Schema

### document_embeddings Table

| Column | Type | Description |
|--------|------|-------------|
| id | BIGINT | Primary key |
| document_id | BIGINT | Foreign key to documents table (unique) |
| embedding | TEXT | JSON array of float values |
| content_hash | VARCHAR(64) | SHA-256 hash of content |
| created_at | TIMESTAMP | When embedding was created |
| updated_at | TIMESTAMP | When embedding was last updated |

**Indexes:**
- `idx_doc_embedding_doc` on `document_id`
- Unique constraint on `document_id`

## Configuration

### Embedding Generation Limits

- **MAX_CONTENT_LENGTH**: 8000 characters
  - Larger documents are truncated to prevent token limits
  - Includes metadata + content

### Content Included in Embeddings

1. Document name
2. Document description  
3. Keywords (comma-separated)
4. Tags (comma-separated)
5. Text content from all `text/*` content objects

## Performance Considerations

### Initial Setup

1. **Generate embeddings** for existing documents:
   ```bash
   curl -X POST http://localhost:8082/api/search/embeddings/rebuild
   ```

2. This will process all documents and generate embeddings
3. Time depends on number of documents and Ollama performance

### Search Performance

- **Small collections** (<1000 docs): In-memory cosine similarity is fast
- **Large collections** (>1000 docs): Consider:
  - Implementing pagination
  - Using approximate nearest neighbor (ANN) algorithms
  - Vector databases (pgvector, Weaviate, etc.)

### Caching

- Embeddings are cached in database
- Only regenerated when content changes (detected via hash)
- Re-use existing embeddings for unchanged documents

## Integration with Existing Search

### Lucene Full-Text Search (Existing)

```bash
GET /api/search?q=spring+framework&limit=50
```

- Keyword-based search
- Supports wildcards, phrases, boolean operators
- Fast for exact matches

### Similarity Search (New)

```bash
POST /api/search/similar?q=spring+framework&limit=10
```

- Semantic/meaning-based search
- Finds related concepts
- Better for "find similar" use cases

### When to Use Which?

| Use Case | Recommended Approach |
|----------|---------------------|
| Exact keyword search | Lucene (`/api/search`) |
| Find documents by specific field values | Lucene field search |
| Find semantically similar documents | Similarity search (`/api/search/similar`) |
| "More like this" feature | Similarity by document ID |
| Explore related topics | Similarity search |
| Duplicate detection | Similarity with high threshold |

## Troubleshooting

### No Results Returned

**Problem**: Similarity search returns empty results

**Solutions**:
1. Check if embeddings exist: Look for entries in `document_embeddings` table
2. Generate embeddings: `POST /api/search/embeddings/rebuild`
3. Verify Ollama is running and accessible
4. Check logs for embedding generation errors

### Low Similarity Scores

**Problem**: All results have very low similarity (<0.3)

**Solutions**:
1. Query text might be too short - provide more context
2. Documents might not be related to query
3. Try adjusting the query or using different keywords

### Slow Performance

**Problem**: Similarity search is slow

**Solutions**:
1. Reduce `limit` parameter
2. Add field filters to narrow results
3. For large datasets, consider:
   - Vector database integration
   - Caching frequent queries
   - Background indexing

### Embedding Generation Fails

**Problem**: Cannot generate embeddings

**Solutions**:
1. Verify Ollama is running: `curl http://localhost:11434/api/tags`
2. Check Ollama has embedding model installed
3. Verify document has text content
4. Check application logs for detailed errors

## Future Enhancements

Potential improvements:
- **Vector Database Integration**: Use pgvector, Qdrant, or Weaviate for better performance at scale
- **Approximate Nearest Neighbor**: Use HNSW or IVF for faster searches on large datasets
- **Multi-modal Embeddings**: Include image and audio content
- **Fine-tuned Embeddings**: Train custom embedding model on domain-specific documents
- **Hybrid Ranking**: Combine Lucene scores with similarity scores
- **Query Expansion**: Automatically expand queries using similar terms
- **Clustering**: Group similar documents automatically

## Examples

### Complete Workflow Example

```bash
# 1. Upload a document (assuming you have one with ID 10)

# 2. Generate its embedding
curl -X POST http://localhost:8082/api/search/embeddings/10

# 3. Find similar documents
curl "http://localhost:8082/api/search/similar/10?limit=5"

# 4. Search by text query
curl -X POST "http://localhost:8082/api/search/similar?q=kubernetes+deployment+guide"

# 5. Hybrid search (similarity + filters)
curl -X POST "http://localhost:8082/api/search/similar?q=kubernetes&limit=10" \
  -H "Content-Type: application/json" \
  -d '{"type": "TUTORIAL"}'
```

### Programmatic Usage

```java
// Inject the service
@Autowired
private DocumentSimilarityService similarityService;

// Generate embedding
Document doc = documentService.findById(docId);
similarityService.generateEmbedding(doc);

// Find similar documents
List<SimilarityResult> similar = similarityService.findSimilar(docId, 10);

// Find by text
List<SimilarityResult> results = similarityService.findSimilarByText("machine learning", 10);

// With filters
Map<String, String> filters = Map.of("type", "TUTORIAL");
List<SimilarityResult> filtered = similarityService.findSimilarByTextWithFilters("java", filters, 10);
```

---

**Status**: âœ… Fully implemented and ready to use
**Requirements**: Ollama running with embedding model
**Compatibility**: Works alongside existing Lucene search
